using FluentAssertions;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.CSharp;
using Xunit;

namespace NOF.SourceGenerator.Tests;

public class QueryParameterGeneratorTests
{
    [Fact]
    public void GenerateQueryParameterExtensions_ForClassWithProperties_GeneratesCorrectExtensionMethod()
    {
        // 准备测试代码
        const string source =
"""
using System;
using NOF;

namespace TestNamespace
{
    [QueryParameter]
    public class TestClass
    {
        public string? Name { get; set; }
        public string Class { get; set; }
        public int? Age { get; set; }
        public DateTime BirthDate { get; set; }
    }
}
""";

        // 预期的生成代码
        const string expectedGeneratedCode =
"""
// <auto-generated/>
#nullable enable

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Text.Json;

namespace NOF
{
    /// <summary>
    /// 查询参数扩展方法
    /// </summary>
    public static class __QueryParameterExtensions__
    {
        /// <summary>
        /// 将TestNamespace.TestClass对象转换为URL查询字符串
        /// </summary>
        /// <param name="source">要转换的TestNamespace.TestClass对象</param>
        /// <returns>URL查询字符串，如果有参数则以?开头</returns>
        public static string ToQueryString(this TestNamespace.TestClass source)
        {
            var queryParams = new Dictionary<string, string>();

            queryParams["Name"] = source.Name?.ToString();
            queryParams["Class"] = source.Class.ToString();
            queryParams["Age"] = source.Age?.ToString();
            queryParams["BirthDate"] = source.BirthDate.ToString();

            var queryStringParts = new List<string>();
            foreach (var param in queryParams)
            {
                if (string.IsNullOrEmpty(param.Value))
                {
                    continue;
                }

                var escapedKey = Uri.EscapeDataString(param.Key);
                var escapedValue = Uri.EscapeDataString(param.Value);
                queryStringParts.Add($"{escapedKey}={escapedValue}");
            }

            return queryStringParts.Count > 0 ? "?" + string.Join("&", queryStringParts) : string.Empty;
        }

    }
}
""";

        // 创建测试编译
        var compilation = CreateCompilation(source);

        // 创建生成器并运行
        var generator = new QueryParameterGenerator();
        var driver = CSharpGeneratorDriver.Create(generator.AsSourceGenerator());

        // 运行生成器
        driver = (CSharpGeneratorDriver)driver.RunGenerators(compilation);

        // 获取生成结果
        var runResult = driver.GetRunResult();

        // 验证生成的文件数量
        runResult.GeneratedTrees.Should().ContainSingle();

        // 获取生成的代码
        var generatedCode = runResult.GeneratedTrees[0].ToString().Trim();

        // 验证生成的代码
        expectedGeneratedCode.Trim().Should().BeEquivalentTo(generatedCode);
    }

    [Fact]
    public void GenerateQueryParameterExtensions_ForMultipleClasses_GeneratesAllExtensionMethods()
    {
        // 准备测试代码
        const string source = @"
using System;
using NOF;

namespace TestNamespace
{
    [QueryParameter]
    public class UserQuery
    {
        public string? Name { get; set; }
        public string? Email { get; set; }
    }

    [QueryParameter]
    public class ProductQuery
    {
        public string? Category { get; set; }
        public decimal? MinPrice { get; set; }
        public decimal? MaxPrice { get; set; }
    }
}";

        // 创建测试编译
        var compilation = CreateCompilation(source);

        // 创建生成器并运行
        var generator = new QueryParameterGenerator();
        var driver = CSharpGeneratorDriver.Create(generator.AsSourceGenerator());

        // 运行生成器
        driver = (CSharpGeneratorDriver)driver.RunGenerators(compilation);

        // 获取生成结果
        var runResult = driver.GetRunResult();

        // 验证生成了一个文件
        runResult.GeneratedTrees.Should().ContainSingle();

        // 获取生成的代码
        var generatedCode = runResult.GeneratedTrees[0].ToString();

        // 验证生成了两个扩展方法
        generatedCode.Should().Contain("public static string ToQueryString(this TestNamespace.UserQuery source)");
        generatedCode.Should().Contain("public static string ToQueryString(this TestNamespace.ProductQuery source)");
    }

    private static Compilation CreateCompilation(string source)
    {
        // 创建语法树
        var syntaxTree = CSharpSyntaxTree.ParseText(source);

        // 创建引用
        var assemblies = AppDomain.CurrentDomain.GetAssemblies()
            .Where(assembly => !assembly.IsDynamic && !string.IsNullOrWhiteSpace(assembly.Location));

        var references = assemblies.Select(
            assembly => MetadataReference.CreateFromFile(assembly.Location))
            .Cast<MetadataReference>()
            .ToList();

        // 添加必要的引用
        references.Add(MetadataReference.CreateFromFile(typeof(object).Assembly.Location));
        references.Add(MetadataReference.CreateFromFile(typeof(Enumerable).Assembly.Location));
        references.Add(MetadataReference.CreateFromFile(typeof(QueryParameterAttribute).Assembly.Location));

        // 创建编译选项
        var compilationOptions = new CSharpCompilationOptions(OutputKind.DynamicallyLinkedLibrary);

        // 创建编译
        var compilation = CSharpCompilation.Create(
            assemblyName: "TestAssembly",
            syntaxTrees: [syntaxTree],
            references: references,
            options: compilationOptions);

        return compilation;
    }
}
