@inject IMessageService Message
@inject ICommandSender Sender
@inject INOFService NOFService

<Tree TItem="TreeNodeData"
      DataSource="@_treeData"
      TitleExpression="@(node => node.DataItem.Title)"
      KeyExpression="@(node => node.DataItem.Key)"
      IsLeafExpression="@(node => node.DataItem.IsLeaf)"
      ChildrenExpression="@(node => node.DataItem.Children)"
      OnNodeLoadDelayAsync="@OnNodeLoadAsync"
      Draggable
      OnDrop="@OnNodeDrop"
      ShowLine
      @bind-SelectedKeys="@_selectedKeys"
      OnClick="@OnNodeClick">
    <TitleTemplate>
        <Dropdown>
            <Overlay>
                <Menu>
                    <MenuItem OnClick="() => OnAddChildClick(context.Key)">
                        <Icon Type="plus" Theme="IconThemeType.Outline" /> 添加子节点
                    </MenuItem>
                    <MenuItem OnClick="() => OnDelete(context.Key)">
                        <Icon Type="delete" Theme="IconThemeType.Outline" /> 删除
                    </MenuItem>
                </Menu>
            </Overlay>
            <ChildContent>
                <span>@context.Title</span>
            </ChildContent>
        </Dropdown>
    </TitleTemplate>
</Tree>

@code {
    [Parameter] public EventCallback<long> OnSelectNode { get; set; }
    [Parameter] public EventCallback<long?> OnAddChild { get; set; }
    [Parameter] public EventCallback<long> OnDeleteNode { get; set; }

    private List<TreeNodeData> _treeData = [];
    private string[] _selectedKeys = [];

    public class TreeNodeData
    {
        public string Key { get; set; } = "";
        public string Title { get; set; } = "";
        public bool IsLeaf { get; set; }
        public List<TreeNodeData>? Children { get; set; }
        public long NodeId { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadRootNodes();
    }

    private async Task LoadRootNodes()
    {
        var result = await NOFService.GetRootConfigNodesAsync(new GetRootConfigNodesRequest());
        var response = Message.UnwrapWithMessage(result);
        var rootNodes = response?.Nodes ?? [];
        _treeData = rootNodes.Select(node => new TreeNodeData
        {
            Key = node.Id.ToString(),
            Title = node.Name,
            NodeId = node.Id,
            IsLeaf = false,
            Children = null
        }).ToList();
    }

    private async Task OnNodeLoadAsync(TreeEventArgs<TreeNodeData> args)
    {
        var nodeId = args.Node.DataItem.NodeId;
        var result = await NOFService.GetConfigNodeChildrenAsync(new GetConfigNodeChildrenRequest(nodeId));
        var children = Message.UnwrapWithMessage(result);

        if (children == null || children.ChildrenIds.Count == 0)
        {
            args.Node.DataItem.Children = [];
            return;
        }

        var childNodes = new List<TreeNodeData>();
        foreach (var childId in children.ChildrenIds)
        {
            var childResult = await NOFService.GetConfigNodeByIdAsync(new GetConfigNodeByIdRequest(childId));
            var childNode = Message.UnwrapWithMessage(childResult)?.Node;
            if (childNode != null)
            {
                childNodes.Add(new TreeNodeData
                {
                    Key = childId.ToString(),
                    Title = childNode.Name,
                    NodeId = childId,
                    IsLeaf = false, // 假设所有节点都可能有子节点
                    Children = null
                });
            }
        }

        args.Node.DataItem.Children = childNodes;
    }

    private async Task OnNodeClick(TreeEventArgs<TreeNodeData> args)
    {
        var nodeId = args.Node.DataItem.NodeId;
        await OnSelectNode.InvokeAsync(nodeId);
    }

    private async Task OnAddChildClick(string key)
    {
        var nodeId = long.Parse(key);
        await OnAddChild.InvokeAsync(nodeId);
    }

    private async Task OnDelete(string key)
    {
        var nodeId = long.Parse(key);
        await OnDeleteNode.InvokeAsync(nodeId);
    }

    private async Task OnNodeDrop(TreeEventArgs<TreeNodeData> args)
    {
        // args.Node 是被拖拽的节点
        // args.TargetNode 是目标节点

        if (args.Node == null || args.TargetNode == null)
        {
            return;
        }

        var dragNodeId = args.Node.DataItem.NodeId;
        var dropNodeId = args.TargetNode.DataItem.NodeId;

        // 根据 DropPosition 决定新的父节点
        long? newParentId;

        if (args.DropBelow)
        {
            // 放到目标节点内部（作为子节点）
            newParentId = dropNodeId;
        }
        else
        {
            // 放到目标节点的前面或后面（作为兄弟节点）
            // 获取目标节点的父节点
            var getNodeResult = await NOFService.GetConfigNodeByIdAsync(new GetConfigNodeByIdRequest(dropNodeId));
            var targetNode = Message.UnwrapWithMessage(getNodeResult)?.Node;
            newParentId = targetNode?.ParentId;
        }

        // 调用服务更新父节点
        var result = await NOFService.UpdateConfigNodeParentAsync(new UpdateConfigNodeParentRequest(dragNodeId, newParentId));
        
        if (result.IsSuccess)
        {
            Message.Success("节点移动成功");
            await LoadRootNodes();
            StateHasChanged();
        }
        else
        {
            Message.Error($"移动失败: {result.Message}");
        }
    }

    public async Task ReloadNode(long? parentId)
    {
        if (parentId == null)
        {
            await LoadRootNodes();
        }
        StateHasChanged();
    }
}
